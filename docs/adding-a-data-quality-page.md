# Adding a data quality page

In order to add a data quality page you have to take the following steps.

1. Create a directory in `/app/main/pages/`. It is perfectly fine to have subdirectories; so for example you could create `/app/main/pages/a/b/` instead of just `/app/main/pages/a/`.
2. In the directory create a file `__init__.py` which defines a function `title` returning the page title and a function `content` returning string with an HTML element containing the page content.

And that's it. Assuming your new directory is `/app/main/pages/a/b/` you can now access the new page at the URL `/data-quality/a/b` (or `/data-quality/a/b/` - trailing slashes are ignored).

In case your page contains a form for query parameters (such as a start and date) you should also have a look at the section on [storing query parameters](docs/storing-query-parameters.md).

## Example: Hello World

Let's create a Hello World page which is accessible at `/data-quality/hello/world`. To this end first create the directory for the page:

```bash
mkdir app/main/pages/hello
mkdir app/main/pages/hello/world
```

In the new directory create a file `__init__.py` with the following content.

```python
def title():
    return 'Hello World'
    
def content():
    return '<div>This is a Hello World page.</div>'
```

You can now view the page by pointing your browser at `/data-quality/hello/world`.

## Data quality content and the `data_quality` decorator

Your page presumably will contain plots, tables etc. Each of these items should be generated by a dedicated function defined in a module within your page's package.

Also, all of these functions should be decorated with the `data_quality` decorator, as shown in the following example.

```python
from app.main.data_quality import data_quality

@data_quality(name='throughput_plot`, caption='Plot of the RSS throughput.', export_name='throughput_plot')
def throughput():
    return '<div>...</div>'
```

The decorator stores the function under the name given by its `name` argument, along with all the arguments (apart from the name) passed to the decorator. You can access these using the `data_quality_item` function (also in the package `app.main.data_quality`), which expects the name (as used in the function's decorator) and package as its arguments.

Within a package the value for the name argument of the `data_quality` decorator must be unique.

The function should return a Bokeh model (such as a plot) or a string containing a valid HTML element.

It is up to you what to with the return value, but it is a good idea to use the `data_quality_item_html` function in the module `app.main.data_quality` to generate it into HTNML for a data quality page. Note that this function automatically creates the relevant HTML for Bokeh models.

## Default data quality pages

If all you need is a page with plots (or tables etc.) stacked one over another, and if this page should contain a form for querying a date range, you can use the `default_data_quality_content_for_date_range` function from the `app.main.data_quality` package to generate the content.

To do so, some requirements must be met.

* All the functions for generating a data quality item (such as a plot) must be decorated with the `data_quality` decorator.
* All of these functions must have the same signature, i.e. accept the same arguments. Most notably, they must accept a `start_date` and `end_date` argument. String values should be accepted for all the function arguments, at least if the function is returning a Bokeh model and you are planning to use the `test_bokeh_model.py` script (see below).
* All these functions must be defined in modules in the page's package.
* All these functions must return a Bokeh model (such as a plot) or a string containing a valid HTML element.
* The data quality items to display must be listed in a file `content.txt`in the page's package. Each line in this file must contain the name for the function generating the item, as passed to the name argument of the `data_quality` decorator.

You have to call the `default_data_quality_content_for_date_range` function with the pages package (as a string), a default start date, a default end date, and any additional arguments to call the data quality item functions with.

## Using Bokeh

While ultimately it is up to you how to create a plot or table, the site is including Bokeh, and it is a good idea to use it. You can just return the created  Bokeh model; there is no need to convert it into HTML. Here is a simple example:

```python
import pandas as pd

from bokeh.embed import components
from bokeh.models.formatters import DatetimeTickFormatter
from bokeh.plotting import figure, ColumnDataSource

from app import db
from app.main.data_quality import data_quality


@data_quality(name='weather_downtime', caption='Weather downtime for May 2016.')
def weather_downtime_plot():
    sql = 'SELECT Date, TimeLostToWeather FROM NightInfo' \
          '       WHERE Date >= \'2016-05-01\' AND Date <= \'2016-05-31\' AND TimeLostToProblems IS NOT NULL'
    df = pd.read_sql(sql, db.engine)
    source = ColumnDataSource(df)

    date_formatter = DatetimeTickFormatter(formats=dict(hours=['%e %b %Y'],
                                                        days=['%e %b %Y'],
                                                        months=['%e %b %Y'],
                                                        years=['%e %b %Y']))

    p = figure(title='Weather Downtime',
               x_axis_label='Date',
               y_axis_label='Downtime (seconds)',
               x_axis_type='datetime')
    p.scatter(source=source, x='Date', y='TimeLostToWeather')

    p.xaxis[0].formatter = date_formatter

    return p
```

Bokeh uses a fairly high z-index (100) for its html elements, which may cause itv to hide other (dynamic) elements like a datepicker. You then have to increase the latter's z-index. In case of a jQuery datepicker you would assigning `position: relative` and `z-index: 1000` to an ancestor of the input field using the datepicker. You may of course choose a value other than 1000, as long as it's higher than the z-index used by Bokeh.

If you require an interactive plot you should refer to the section below. 

## Example: a default data quality page

Let's create a default data quality page `/data-quality/general/downtime` with a weather and engineering downtime plot. Both plots are for a date range supplied by the user.

The first step is to create the necessary directory.

```bash
mkdir app/main/pages/general
mkdir app/main/pages/general/downtime
```

In the new directory create a file `__init__.py` with the following content.

```python
import datetime

from app.main.data_quality import default_data_quality_content_for_date_range


def title():
    return 'Telescope Downtime'


def content():
    return default_data_quality_content_for_date_range(__package__,
                                                       datetime.date.today() - datetime.timedelta(days=7),
                                                       datetime.date.today())
```

Add a file `plots.py` for the plot functions, with the following content.

```python
import pandas as pd

from bokeh.embed import components
from bokeh.models.formatters import DatetimeTickFormatter
from bokeh.plotting import figure, ColumnDataSource

from app import db
from app.main.data_quality import data_quality


@data_quality(name='weather_downtime', caption='Weather downtime.')
def weather_downtime_plot(start_date, end_date):
    """Return a <div> element with a weather downtime plot.

    The plot shows the downtime for the period between start_date (inclusive) and end_date (exclusive).

    Params:
    -------
    start_date: date
        Earliest date to include in the plot.
    end_date: date
        Earliest date not to include in the plot.

    Return:
    -------
    str:
        A <div> element with the weather downtime plot.
    """

    return _downtime_plot('TimeLostToWeather', 'Weather Downtime', start_date, end_date)


@data_quality(name='technical_downtime', caption='Downtime due to technical problems.')
def technical_downtime_plot(start_date, end_date):
    """Return a <div> element with a plot displaying the downtime due to technical problems.

    The plot shows the downtime for the period between start_date (inclusive) and end_date (exclusive).

    Params:
    -------
    start_date: date
        Earliest date to include in the plot.
    end_date: date
        Earliest date not to include in the plot.

    Return:
    -------
    str:
        A <div> element with the weather downtime plot.
    """

    return _downtime_plot('TimeLostToProblems', 'Downtime due to Technical Problems', start_date, end_date)


def _downtime_plot(downtime_column, title, start_date, end_date):
    """Return a <div> element with a downtime plot.

    The plot shows the downtime for the period between start_date (inclusive) and end_date (exclusive).

    Params:
    -------
    downtime_column: str
        Name of the column in the NightInfo table whose data shall be used.
    title: str
        Plot title.
    start_date: date
        Earliest date to include in the plot.
    end_date: date
        Earliest date not to include in the plot.

    Return:
    -------
    bokeh.model.Model:
        The downtime plot.
    """

    sql = 'SELECT Date, {downtime_column} FROM NightInfo' \
          '       WHERE Date >= \'{start_date}\' AND Date < \'{end_date}\' AND {downtime_column} IS NOT NULL' \
        .format(start_date=start_date, end_date=end_date, downtime_column=downtime_column)
    df = pd.read_sql(sql, db.engine)
    source = ColumnDataSource(df)

    date_formatter = DatetimeTickFormatter(formats=dict(hours=['%e %b %Y'],
                                                        days=['%e %b %Y'],
                                                        months=['%e %b %Y'],
                                                        years=['%e %b %Y']))

    p = figure(title=title,
               x_axis_label='Date',
               y_axis_label='Downtime (seconds)',
               x_axis_type='datetime')
    p.scatter(source=source, x='Date', y='{downtime_column}'.format(downtime_column=downtime_column))

    p.xaxis[0].formatter = date_formatter

    script, div = components(p)

    return '<div>{script}{div}</div>'.format(script=script, div=div)
```
 
Finally, create a file `content.txt` with the following content.
 
```
weather_downtime
technical_downtime
```

Your new page is now accessible at `/data-quality/general/downtime`.
